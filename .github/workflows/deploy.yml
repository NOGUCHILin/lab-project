name: Deploy to NixOS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout lab-project repository
        uses: actions/checkout@v4

      # Nixã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      # Tailscaleã«æ¥ç¶š
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      # SSHç§˜å¯†éµã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "$NIXOS_ROOT_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          # StrictHostKeyChecking=accept-newã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€ssh-keyscanã¯ä¸è¦
        env:
          NIXOS_ROOT_SSH_KEY: ${{ secrets.NIXOS_ROOT_SSH_KEY }}

      # nakamura-misaki User Tokenã‚’æ›´æ–°
      - name: Update nakamura-misaki User Token in sops
        run: |
          ssh -o StrictHostKeyChecking=accept-new root@home-lab-01.tail4ed625.ts.net "
            cd /etc/nixos
            # sops-nixã§æš—å·åŒ–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°
            export SOPS_AGE_KEY_FILE=/etc/nixos/age-key.txt
            echo 'slack_bot_token: ${{ secrets.NAKAMURA_MISAKI_USER_TOKEN }}' | \
              sops --input-type yaml --output-type yaml \
              --set '.[\"slack_bot_token\"]' \
              secrets/nakamura-misaki.yaml

            echo 'âœ… nakamura-misaki User Token updated in sops'
          "

      # deploy-rsã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (ãƒã‚¤ãƒŠãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—)
      - name: Install deploy-rs
        run: |
          nix profile install nixpkgs#deploy-rs

      # deploy-rsã§NixOSè¨­å®šã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ (Dashboard & nakamura-misakiä¸¡æ–¹ã¨ã‚‚Nixãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–æ¸ˆã¿)
      # --remote-buildå¿…é ˆ: NixOSã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ãƒ“ãƒ«ãƒ‰ã¯ãƒªãƒ¢ãƒ¼ãƒˆã§å®Ÿè¡ŒãŒå¿…è¦
      - name: Deploy NixOS configuration with deploy-rs
        run: |
          cd nixos-config
          deploy \
            --skip-checks \
            --remote-build \
            --ssh-user root \
            --ssh-opts "-o StrictHostKeyChecking=accept-new" \
            .#home-lab-01

      # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
      - name: Run database migrations
        run: |
          echo "ğŸ”„ Running database migrations for nakamura-misaki..."
          ssh -o StrictHostKeyChecking=accept-new root@home-lab-01.tail4ed625.ts.net '
            cd /home/noguchilin/projects/lab-project/nakamura-misaki

            # uvã‚’ä½¿ã£ã¦alembicãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
            uv run alembic upgrade head

            # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã‚’ç¢ºèª
            echo "âœ… Migration completed. Current version:"
            psql -U nakamura_misaki -d nakamura_misaki -c "SELECT version_num FROM alembic_version;"
          '

      # ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ç¢ºèª
      - name: Verify deployment
        run: |
          ssh -o StrictHostKeyChecking=accept-new root@home-lab-01.tail4ed625.ts.net '
            echo "ğŸ“Š Service status:"
            systemctl status dashboard.service --no-pager || true
            systemctl status nakamura-misaki.service --no-pager || true

            echo ""
            echo "ğŸ” Recent logs (last 20 lines):"
            journalctl -u nakamura-misaki.service -n 20 --no-pager || true
          '

      # ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•å¾…æ©Ÿ
      - name: Wait for service startup
        run: |
          echo "â³ Waiting 30 seconds for services to start..."
          sleep 30

      # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆnakamura-misaki APIï¼‰
      - name: Health Check (nakamura-misaki API)
        id: health_check
        continue-on-error: true
        run: |
          echo "ğŸ¥ Performing health check on nakamura-misaki API..."

          # Tailscaleãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’SSHçµŒç”±ã§å–å¾—ï¼ˆjqã‚’ä½¿ã‚ãšã«ãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›ã‹ã‚‰æŠ½å‡ºï¼‰
          TAILSCALE_DOMAIN=$(ssh -o StrictHostKeyChecking=accept-new root@home-lab-01.tail4ed625.ts.net "tailscale status | grep -E '^\s*\S+\s+\S+.*this machine' | awk '{print \$2}'" | head -1)

          # ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒå–å¾—ã§ããªã‹ã£ãŸå ´åˆã¯hostnameã‚’ä½¿ç”¨
          if [ -z "$TAILSCALE_DOMAIN" ]; then
            TAILSCALE_DOMAIN=$(ssh -o StrictHostKeyChecking=accept-new root@home-lab-01.tail4ed625.ts.net "hostname -f")
          fi

          echo "Tailscale domain: $TAILSCALE_DOMAIN"

          # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€å¤§5å›ãƒªãƒˆãƒ©ã‚¤ã€å„5ç§’é–“éš”ï¼‰
          for i in {1..5}; do
            echo "Attempt $i/5..."
            if curl -f --max-time 10 "https://${TAILSCALE_DOMAIN}:10000/health"; then
              echo "âœ… Health check passed!"
              echo "status=success" >> $GITHUB_OUTPUT
              exit 0
            fi

            if [ $i -lt 5 ]; then
              echo "â³ Retrying in 5 seconds..."
              sleep 5
            fi
          done

          echo "âŒ Health check failed after 5 attempts"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1

      # å¤±æ•—æ™‚ã®è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
      - name: Auto Rollback on Health Check Failure
        if: failure() && steps.health_check.outputs.status == 'failed'
        run: |
          echo "âš ï¸ Health check failed. Rolling back to previous NixOS generation..."

          ssh -o StrictHostKeyChecking=accept-new root@home-lab-01.tail4ed625.ts.net "
            echo 'ğŸ”„ Rolling back to previous generation...'
            nixos-rebuild switch --rollback

            echo 'â³ Waiting for services to restart...'
            sleep 15

            echo 'ğŸ“Š Post-rollback service status:'
            systemctl status nakamura-misaki.service --no-pager || true
          "

          # ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¾Œã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
          echo "ğŸ¥ Verifying rollback succeeded..."
          sleep 10

          # Tailscaleãƒ‰ãƒ¡ã‚¤ãƒ³å–å¾—ï¼ˆjqä¸è¦ã®æ–¹æ³•ï¼‰
          TAILSCALE_DOMAIN=$(ssh -o StrictHostKeyChecking=accept-new root@home-lab-01.tail4ed625.ts.net "tailscale status | grep -E '^\s*\S+\s+\S+.*this machine' | awk '{print \$2}'" | head -1)
          if [ -z "$TAILSCALE_DOMAIN" ]; then
            TAILSCALE_DOMAIN=$(ssh -o StrictHostKeyChecking=accept-new root@home-lab-01.tail4ed625.ts.net "hostname -f")
          fi

          if curl -f --max-time 10 "https://${TAILSCALE_DOMAIN}:10000/health"; then
            echo "âœ… Rollback successful! Service is healthy."
          else
            echo "âŒ WARNING: Rollback completed but health check still failing!"
            echo "Manual intervention may be required."
          fi

          # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å…¨ä½“ã‚’å¤±æ•—æ‰±ã„ã«ã™ã‚‹
          exit 1
