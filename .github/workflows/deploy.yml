name: Deploy to NixOS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout lab-project repository
        uses: actions/checkout@v4

      # Nixã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      # Tailscaleã«æ¥ç¶š
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      # SSHç§˜å¯†éµã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "$NIXOS_ROOT_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H home-lab-01 >> ~/.ssh/known_hosts
        env:
          NIXOS_ROOT_SSH_KEY: ${{ secrets.NIXOS_ROOT_SSH_KEY }}

      # Dashboard & Nakamura-Misakiã‚³ãƒ¼ãƒ‰ã‚’åŒæœŸ
      - name: Sync application code
        run: |
          ssh root@home-lab-01 '
            # lab-projectã‚³ãƒ¼ãƒ‰å–å¾—ï¼ˆGitHubã‹ã‚‰ï¼‰
            cd /tmp
            rm -rf lab-project-temp
            git clone --filter=blob:none --no-checkout --depth 1 https://github.com/NOGUCHILin/lab-project.git lab-project-temp
            cd lab-project-temp
            git sparse-checkout init --cone
            git sparse-checkout set projects/dashboard nakamura-misaki
            git checkout main

            # ~/projects/dashboard/ ã«åŒæœŸ
            rsync -av --delete \
              --exclude="node_modules" \
              --exclude=".next" \
              projects/dashboard/ /home/noguchilin/projects/dashboard/

            # ~/projects/lab-project/nakamura-misaki/ ã«åŒæœŸ
            mkdir -p /home/noguchilin/projects/lab-project
            rsync -av --delete \
              --exclude=".venv" \
              --exclude="node_modules" \
              --exclude="workspaces/user_*" \
              --exclude="workspaces/sessions/*.json" \
              nakamura-misaki/ /home/noguchilin/projects/lab-project/nakamura-misaki/

            # ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤
            rm -rf /tmp/lab-project-temp
          '

      # deploy-rsã§NixOSè¨­å®šã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: Deploy NixOS configuration with deploy-rs
        run: |
          cd nixos-config
          nix run github:serokell/deploy-rs -- \
            --skip-checks \
            --remote-build \
            --ssh-user root \
            --ssh-opts "-o StrictHostKeyChecking=accept-new" \
            .#home-lab-01

      # ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ç¢ºèª
      - name: Verify deployment
        run: |
          ssh root@home-lab-01 '
            echo "ğŸ“Š Service status:"
            systemctl status dashboard.service --no-pager || true
            systemctl status nakamura-misaki-api.service --no-pager || true

            echo ""
            echo "ğŸ” Recent logs (last 20 lines):"
            journalctl -u nakamura-misaki-api.service -n 20 --no-pager || true
          '
