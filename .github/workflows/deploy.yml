name: Deploy to NixOS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout lab-project repository
        uses: actions/checkout@v4

      # Nixをインストール
      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      # Tailscaleに接続
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      # SSH秘密鍵をセットアップ
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "$NIXOS_ROOT_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H home-lab-01 >> ~/.ssh/known_hosts
        env:
          NIXOS_ROOT_SSH_KEY: ${{ secrets.NIXOS_ROOT_SSH_KEY }}

      # nakamura-misaki User Tokenを更新
      - name: Update nakamura-misaki User Token in sops
        run: |
          ssh root@home-lab-01 "
            cd /etc/nixos
            # sops-nixで暗号化ファイルを更新
            export SOPS_AGE_KEY_FILE=/etc/nixos/age-key.txt
            echo 'slack_bot_token: ${{ secrets.NAKAMURA_MISAKI_USER_TOKEN }}' | \
              sops --input-type yaml --output-type yaml \
              --set '.[\"slack_bot_token\"]' \
              secrets/nakamura-misaki.yaml

            echo '✅ nakamura-misaki User Token updated in sops'
          "

      # Dashboardコードを同期（dashboardのみ、nakamura-misakiはNixパッケージ化済み）
      - name: Sync Dashboard code
        run: |
          ssh root@home-lab-01 '
            # lab-projectコード取得（GitHubから）
            cd /tmp
            rm -rf lab-project-temp
            git clone --filter=blob:none --no-checkout --depth 1 https://github.com/NOGUCHILin/lab-project.git lab-project-temp
            cd lab-project-temp
            git sparse-checkout init --cone
            git sparse-checkout set projects/dashboard
            git checkout main

            # ~/projects/dashboard/ に同期
            rsync -av --delete \
              --exclude="node_modules" \
              --exclude=".next" \
              projects/dashboard/ /home/noguchilin/projects/dashboard/

            # 一時ディレクトリ削除
            rm -rf /tmp/lab-project-temp
          '

      # deploy-rsでNixOS設定をデプロイ
      - name: Deploy NixOS configuration with deploy-rs
        run: |
          cd nixos-config
          nix run github:serokell/deploy-rs -- \
            --skip-checks \
            --remote-build \
            --ssh-user root \
            --ssh-opts "-o StrictHostKeyChecking=accept-new" \
            .#home-lab-01

      # サービス状態確認
      - name: Verify deployment
        run: |
          ssh root@home-lab-01 '
            echo "📊 Service status:"
            systemctl status dashboard.service --no-pager || true
            systemctl status nakamura-misaki.service --no-pager || true

            echo ""
            echo "🔍 Recent logs (last 20 lines):"
            journalctl -u nakamura-misaki.service -n 20 --no-pager || true
          '
