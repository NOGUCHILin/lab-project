# lab-project セッション記録

**日付**: 2025-10-07
**セッション**: NixOS統合リポジトリ構築 + 自動デプロイ設定

---

## 📋 完了事項

### 1. ✅ lab-project統合リポジトリ作成
- **リポジトリ**: https://github.com/NOGUCHILin/lab-project
- **目的**: アプリケーションコード + NixOS設定を一つのリポジトリで管理
- **構成**:
  ```
  lab-project/
  ├── nixos-config/              # NixOS Flakes設定
  │   ├── flake.nix
  │   ├── hosts/home-lab-01/
  │   ├── modules/
  │   │   └── nginx.nix         # リバースプロキシ設定
  │   └── users/
  └── projects/                  # サービス定義
      ├── dashboard/service.nix
      ├── nakamura-misaki/service.nix
      ├── code-server/service.nix
      ├── filebrowser/service.nix
      └── nats/service.nix
  ```

### 2. ✅ GitHub Actions自動デプロイ設定
- **ワークフロー**: `.github/workflows/deploy.yml`
- **トリガー**: `main`ブランチへのpush
- **デプロイフロー**:
  1. GitHub Actions起動
  2. Tailscale接続（OAuth認証）
  3. SSH経由でNixOSに接続
  4. `git pull` + `nixos-rebuild switch`
  5. サービス起動確認

### 3. ✅ Tailscale統合
- **OAuth Client作成**: GitHub Actions用
- **ACL設定**: `tag:ci` タグで権限管理
- **GitHub Secrets**:
  - `TS_OAUTH_CLIENT_ID`: `kUxKjniuWt11CNTRL`
  - `TS_OAUTH_SECRET`: `tskey-client-kUxKjniuWt11CNTRL-2hTcY6K7RwKh6GQsR76XwKaoKX9VskUd`
  - `NIXOS_HOST`: `100.88.235.122`
  - `NIXOS_USER`: `noguchilin`
  - `NIXOS_SSH_KEY`: SSH秘密鍵（`~/.ssh/github-actions-deploy`）

### 4. ✅ Nginx リバースプロキシ設定
- **ファイル**: `nixos-config/modules/nginx.nix`
- **ポート80で提供**:
  - Dashboard: `/` → `localhost:3000`
  - Nakamura Misaki API: `api.home-lab-01.tail4ed625.ts.net` → `localhost:8000`
  - Code Server: `code.home-lab-01.tail4ed625.ts.net` → `localhost:8080`
  - Filebrowser: `files.home-lab-01.tail4ed625.ts.net` → `localhost:8081`

### 5. ✅ NixOS既存設定の移行
- **元**: `~/nixos-config`（独立リポジトリ）
- **移行先**: `~/nixos-config` = `lab-project` clone
- **サービス定義**: `modules/services/` → `projects/*/service.nix` に再配置
- **Git管理の一元化**: すべての設定をlab-projectで管理

### 6. ✅ AppleBuyers Public Site統合計画
- **ドキュメント作成**:
  - `lab-project/.claude/applebuyers-integration-proposal.md`（提案）
  - `lab-project/.claude/public-site-nixos-deployment.md`（実装ガイド）
- **推奨アーキテクチャ**: Sparse Checkout + 独立GitHub Actions
- **理由**: public-siteは完全独立プロジェクト、モノレポ依存なし

---

## 🎯 現在の状態

### デプロイフロー（確立済み）
```
[開発者]
  ↓ git push origin main
[GitHub: lab-project]
  ↓ GitHub Actions
  ↓ Tailscale OAuth認証
  ↓ SSH接続
[NixOS: home-lab-01]
  ↓ git pull
  ↓ nixos-rebuild switch
  ↓ サービス再起動
[稼働中サービス]
  - Dashboard (port 3000)
  - Nakamura Misaki API (port 8000)
  - Code Server (port 8080)
  - Filebrowser (port 8081)
  - NATS (port 4222)
```

### アクセスURL
- **Dashboard**: `https://home-lab-01.tail4ed625.ts.net/`
- **API**: `https://api.home-lab-01.tail4ed625.ts.net/`
- **Code Server**: `https://code.home-lab-01.tail4ed625.ts.net/`
- **Filebrowser**: `https://files.home-lab-01.tail4ed625.ts.net/`

### NixOS側のプロジェクト状況
**管理状況（`~/projects/`）**:
1. ✅ **nakamura-misaki**: Git管理済み（`git@github.com:NOGUCHILin/nakamura-misaki.git`）
2. ✅ **applebuyers_application**: Git管理済み（`https://github.com/NOGUCHILin/applebuyers_application.git`）
3. ⚠️ **dashboard**: ローカルGit初期化のみ、リモートリポジトリ未設定
4. ✅ **syncthing-data**: クリーンアップ完了（削除済み）

---

## 🔧 重要な設定・認証情報

### SSH鍵（GitHub Actions用）
**場所**: `~/.ssh/github-actions-deploy` (private), `~/.ssh/github-actions-deploy.pub` (public)
**用途**: GitHub ActionsからNixOSへのSSH接続
**公開鍵追加先**: NixOS `~/.ssh/authorized_keys`

### Tailscale OAuth Client
**Client ID**: `kUxKjniuWt11CNTRL`
**スコープ**:
- Devices > Core: Write
- Keys > Auth Keys: Write
**タグ**: `tag:ci`

**ACL設定** (`tailscale.com/admin/acls`):
```json
{
  "tagOwners": {
    "tag:ci": ["autogroup:admin"]
  }
}
```

### Git設定（NixOS側）
**問題**: NixOS側で手動編集した設定ファイルが未コミット状態
**解決**: ワークフローに `git stash` を追加
```bash
cd ~/nixos-config
git stash           # 未コミット変更を退避
git pull origin main
sudo nixos-rebuild switch
```

---

## 📝 次のタスク（未完了）

### AppleBuyers Public Site統合
**優先度**: 高

#### Phase 1: GitHub Actions設定（applebuyers_application側）
- [ ] `.github/workflows/deploy-public-site.yml` 作成
- [ ] GitHub Secrets設定（6つのSecret）
  - `TS_OAUTH_CLIENT_ID`
  - `TS_OAUTH_SECRET`
  - `NIXOS_HOST`
  - `NIXOS_USER`
  - `NIXOS_SSH_KEY`

#### Phase 2: NixOS初期セットアップ
- [ ] Sparse Checkout初期化
  ```bash
  cd ~/projects
  git clone --filter=blob:none --no-checkout \
    https://github.com/NOGUCHILin/applebuyers_application.git
  cd applebuyers_application
  git sparse-checkout set public-site
  git checkout main
  cd public-site
  pnpm install && pnpm build
  ```
- [ ] `nixos-config/projects/applebuyers-public-site/service.nix` 作成
- [ ] `nixos-config/flake.nix` に追加
- [ ] lab-projectにコミット・プッシュ

#### Phase 3: 動作確認
- [ ] GitHub Actionsテスト実行
- [ ] サービス起動確認
- [ ] アクセス確認（`http://home-lab-01.tail4ed625.ts.net:13005/`）

### nakamura-misakiプロジェクト
**優先度**: 中
- [ ] 既存コードをlab-projectに統合（検討中）
- [ ] admin-ui.nixの有効化（コード統合後）

### dashboardプロジェクト
**優先度**: 低
- [ ] GitHubリモートリポジトリ作成
- [ ] 既存コードをpush
- [ ] lab-projectに統合（検討中）

---

## 🐛 遭遇した問題と解決

### 問題1: Tailscale OAuth 403エラー
**エラー**: `Status: 403, Message: "calling actor does not have enough permissions"`
**原因**: OAuth Clientの権限不足（Read権限のみ）
**解決**:
1. OAuth Client削除・再作成
2. Devices > Core: **Write**権限に変更
3. Auth Keys: **Write**権限追加
4. タグ `tag:ci` 設定（ACL設定が必要）

### 問題2: Git pull失敗（未コミット変更）
**エラー**: `error: Your local changes to the following files would be overwritten by merge`
**原因**: NixOS側で手動編集した設定ファイルが未コミット
**解決**: ワークフローに `git stash` 追加

### 問題3: Nginxが起動していない
**症状**: ポート80でアクセスできない、Dashboardが重い
**原因**: Nginxがインストール・設定されていなかった
**解決**:
1. `nixos-config/modules/nginx.nix` 作成
2. `flake.nix` にモジュール追加
3. GitHub Actions経由でデプロイ

### 問題4: Dashboardのストリーミングエラー
**エラー**: `TypeError: Invalid state: Controller is already closed`
**原因**: SSE（Server-Sent Events）接続の切断処理問題
**影響**: システムメトリクスのリアルタイム更新が動作不安定
**状態**: 未解決（Dashboard本体の問題、別途対応予定）

---

## 📚 作成したドキュメント

1. **nixos-deploy-plan.md** (`~/dev/nixos-deploy-plan.md`)
   - 初期計画ドキュメント（A41枚）
   - リポジトリ構成、デプロイフロー

2. **applebuyers-integration-proposal.md** (`lab-project/.claude/`)
   - AppleBuyers統合の3つの案を比較検討
   - 推奨アーキテクチャ: Sparse Checkout + 独立GitHub Actions

3. **public-site-nixos-deployment.md** (`lab-project/.claude/`)
   - AppleBuyers Public Site実装ガイド
   - Phase 1-3の詳細手順
   - ライター向け作業フロー

4. **session-2025-10-07.md** (このファイル)
   - セッション記録・引き継ぎ用

---

## 💡 学んだこと・ベストプラクティス

### NixOS Flakes設定
- サービス定義は `projects/*/service.nix` で分離
- `flake.nix` からモジュールとしてimport
- `nixos-rebuild switch --flake` で即座に反映

### GitHub Actions + Tailscale
- OAuth認証でCI/CD環境から安全にアクセス
- タグベースのACL管理でセキュアに
- SSH鍵はリポジトリSecretsで管理

### Git Sparse Checkout
- 大きなモノレポから特定ディレクトリのみclone可能
- `--filter=blob:none` でblob（ファイル内容）を遅延取得
- 独立したプロジェクトなら問題なく動作

### デプロイワークフロー
- `git stash` で未コミット変更を自動退避
- サービス起動確認をワークフローに含める
- 失敗時のログ確認が重要

---

## 🔗 参考リンク

- **lab-project リポジトリ**: https://github.com/NOGUCHILin/lab-project
- **applebuyers_application**: https://github.com/NOGUCHILin/applebuyers_application
- **nakamura-misaki**: https://github.com/NOGUCHILin/nakamura-misaki
- **Tailscale管理画面**: https://login.tailscale.com/admin
- **GitHub Actions**: https://github.com/NOGUCHILin/lab-project/actions

---

## 🚀 新しいセッションでの作業開始方法

1. **プロジェクトを開く**:
   ```bash
   cd ~/dev/lab-project
   code .
   ```

2. **このドキュメントを読み込む**:
   ```
   "このセッション記録を読んでください: .claude/session-2025-10-07.md"
   ```

3. **次のタスクを開始**:
   - AppleBuyers Public Site統合
   - または nakamura-misaki/dashboard の検討

---

**最終更新**: 2025-10-07 13:30
**次回セッション**: lab-projectワークスペースで開始すること
